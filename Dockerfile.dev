FROM node:18-alpine

WORKDIR /app

# Copy workspace config and lockfile
COPY package.json package-lock.json tsconfig.base.json ./

# Copy all workspace package.json and config files
COPY apps/api/package.json apps/api/tsconfig.json apps/api/nest-cli.json ./apps/api/
COPY apps/web/package.json apps/web/tsconfig.json apps/web/tsconfig.node.json apps/web/vite.config.ts apps/web/index.html ./apps/web/
COPY packages/shared-types/package.json packages/shared-types/tsconfig.json ./packages/shared-types/
COPY packages/shared-utils/package.json packages/shared-utils/tsconfig.json ./packages/shared-utils/

# Install all dependencies (including devDependencies)
RUN npm ci

# Copy all source code
COPY packages/shared-types/src ./packages/shared-types/src
COPY packages/shared-utils/src ./packages/shared-utils/src
COPY apps/api/src ./apps/api/src
COPY apps/api/prisma ./apps/api/prisma
COPY apps/web/src ./apps/web/src

# Generate Prisma client
RUN cd apps/api && npx prisma generate
